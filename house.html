
<html>
<body></body>

<canvas style="border: none;" width="300" height="300"></canvas>


<script src="../build/element.js"></script>
<script src="../build/add-html.js"></script>
<script src="../build/function-call.js"></script>
<script src="../build/make-it-editable.js"></script>
<script src="../build/draw-scene.js"></script>

<script id="fill-shader" type="x-shader/x-fragment">
    precision mediump float;

    varying vec4 vColor;

    void main(void) {
        gl_FragColor = vColor;
    }
</script>

<script id="geometry-shader" type="x-shader/x-vertex">
    attribute vec3 aVertexPosition;
    attribute vec4 aVertexColor;

    uniform mat4 uniformModelViewMatrix;
    uniform mat4 uniformProjectionMatrix;

    varying vec4 vColor;

    void main(void) {
        gl_Position = uniformProjectionMatrix * uniformModelViewMatrix * vec4(aVertexPosition, 1.0);
        vColor = aVertexColor;
    }
</script>

<script>

// Our world


var shapes = [
  {
    name: "triangle",
    position: [-1.5, 0.0, -7.0],
    verticies: [
       0.0,  1.0,  0.0,
      -1.0, -1.0,  0.0,
       1.0, -1.0,  0.0
    ],
    pointCount: 3,
    colors: [
      1.0, 0.4, 0.6, 1.0,
      0.9, 0.4, 0.7, 1.0,
      0.8, 0.4, 0.9, 1.0
    ]
  },
  {
    name: "square",
    position: [3.0, 0.0, 0.0],
    verticies: [
       1.0,  1.0,  0.0,
      -1.0,  1.0,  0.0,
       1.0, -1.0,  0.0,
      -1.0, -1.0,  0.0
    ],
    pointCount: 4,
    colors: [
      1.0, 0.8, 0.2, 1.0,
      0.9, 0.7, 0.4 , 1.0,
      0.8, 0.7, 0.6, 1.0,
      0.7, 0.6, 0.8, 1.0
    ]
  },
]

function getShapeData(shapeId, key, i) {
  return shapes[shapeId][key][i]
}

function setShapeData(shapeId, key, i, value) {
  shapes[shapeId][key][i] = value
  render()
}



// Data

var button = element.template.container(
  ".button",
  element.style({
    "font-family": "sans-serif",
    "padding": "8px 12px 10px 12px",
    "display": "inline-block",
    "font-size": "11pt"
  })
)

var valueTemplate = element.template(
  button,
  ".value",
  element.style({
    "background": "white",
    "margin-right": "10px"
  }),
  function(value, shapeId, key, i) {
    this.children = [element.raw(""+value)]

    makeItEditable(
      this,
      functionCall(getShapeData).withArgs(shapeId, key, i),
      functionCall(setShapeData).withArgs(shapeId, key, i)
    )
  }
)

var shapeTemplate = element.template(
  ".shape-code",
  element.style({
    "background": "#fafafa",
    "margin-bottom": "10px",
    "max-width": "300px"
  }),
  function(shape, id) {
    this.attributes.style = 
    "color: rgb("
    +parseInt(shape.colors[0]*255)+","
    +parseInt(shape.colors[1]*255)+","
    +parseInt(shape.colors[2]*255)
    +");"

    this.children = [
      inputs(id, "position", shape.position),
      inputs(id, "verticies", shape.verticies),
      inputs(id, "colors", shape.colors),
      inputs(id, "pointCount", [shape.pointCount])
    ]

  }
)

var inputs = element.template(
  ".inputs",
  element.style({
    "margin-bottom": "10px" 
  }),
  function inputs(shapeId, key, values) {
    this.children.push(button(key))

    for(var i=0; i<values.length; i++) {
      valueElement = valueTemplate(values[i], shapeId, key, i)

      this.children.push(valueElement)
    }
  }
)


function drawCode(shapes) {
  addHtml(
    element.stylesheet(
      valueTemplate,
      shapeTemplate,
      button,
      inputs,
      cameraPosition
    ).html()
  )

  for(var i=0; i<shapes.length; i++) {
    var shape = shapes[i]
    var el = shapeTemplate(shape, i)
    addHtml(el.html())
  }

}

var cameraPosition = element.template(
  ".camera-position.button",
  element.style({
    "background": "#bbf",
    "color": "white",
    "margin": "0 10px 10px 0",
    "cursor": "pointer"
  }),
  function(name) {
    this.children = [element(name+" camera")]
    this.onclick(
      functionCall(setCameraPosition)
      .withArgs(name)
    )
  }
)

var cameras = {
  "over the shoulder": {
    pitch: 0.2
  }
}


function setCameraPosition(name) {
    if (!cameras[name]) {
    throw new Error("No camera named "+name)
  }
  camera.yaw = cameras[name].yaw
  render()
  console.log("rerendered")
}

function drawCameraPositions() {
  addHtml(
    element([
      cameraPosition("front"),
      cameraPosition("over the shoulder")
    ]).html()
  )
}

var camera = {
  fovy: 45,
  near: 0.1,
  far: 100.0,
  pitch: 0.0,
  yaw: 0.0,
  xPos: 0.0,
  yPos: 0.4,
  zPos: 0.0  
}

function render() {
  drawScene.buffer(shapes)
  drawScene(shapes, camera)
}

render()

drawCameraPositions()

drawCode(shapes)


</script>

</html>